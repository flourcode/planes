<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PlanePatrol">
    <title>PlanePatrol</title>
    <script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #0d0d0f;
        --bg-warm: #121214;
        --surface: rgba(32, 32, 36, 0.75);
        --surface-elevated: rgba(48, 48, 54, 0.85);
        --text-primary: #f5f5f7;
        --text-secondary: rgba(245, 245, 247, 0.55);
        --text-tertiary: rgba(245, 245, 247, 0.35);
        --accent: #6e9fff;
        --accent-soft: rgba(110, 159, 255, 0.15);
        --accent-glow: rgba(110, 159, 255, 0.25);
        --success: #34c759;
        --warning: #ffb340;
        --danger: #ff6961;
        --separator: rgba(255, 255, 255, 0.06);
        --icon-color: #e8e8eb;
        --safe-top: env(safe-area-inset-top, 20px);
        --safe-bottom: env(safe-area-inset-bottom, 20px);
        --blur: blur(40px) saturate(180%);
        --transition-fast: 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        --transition-medium: 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
        --transition-slow: 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
        --map-filter: grayscale(100%) invert(100%) brightness(38%) contrast(110%) sepia(5%);
    }

    :root.light-theme {
        --bg: #f2f2f7;
        --bg-warm: #ffffff;
        --surface: rgba(255, 255, 255, 0.75);
        --surface-elevated: rgba(255, 255, 255, 0.9);
        --text-primary: #1c1c1e;
        --text-secondary: rgba(60, 60, 67, 0.6);
        --text-tertiary: rgba(60, 60, 67, 0.4);
        --separator: rgba(0, 0, 0, 0.08);
        --icon-color: #1c1c1e;
        --map-filter: grayscale(20%) brightness(105%) contrast(95%);
    }

    * {
        margin: 0; padding: 0; box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-font-smoothing: antialiased;
    }

    html, body {
        height: 100%; width: 100%;
        background: var(--bg);
        color: var(--text-primary);
        font-family: 'Space Mono', monospace;
        overflow: hidden;
        overscroll-behavior: none;
    }

    /* === VIEWS === */
    #main-view {
        position: absolute; inset: 0; z-index: 10;
        opacity: 1;
        transition: opacity var(--transition-slow);
    }
    #main-view.hidden { opacity: 0; pointer-events: none; }

    #cockpit-view {
        position: absolute; inset: 0; z-index: 20;
        opacity: 0; pointer-events: none;
        background: var(--bg);
        transition: opacity var(--transition-slow);
    }
    #cockpit-view.active { opacity: 1; pointer-events: auto; }

    /* === MAPS === */
    #map {
        position: absolute; inset: 0; z-index: 0;
        background: var(--bg);
        filter: var(--map-filter);
        transition: filter var(--transition-medium);
    }
    #cockpitMap { position: absolute; inset: 0; z-index: 0; background: var(--bg); }
    .maplibregl-canvas { filter: none !important; }
    .maplibregl-ctrl { display: none !important; }

    /* === SPLASH SCREEN === */
    .splash-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: var(--bg);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    }
    .splash-screen.hidden {
        opacity: 0; pointer-events: none;
        transform: scale(1.05);
    }
    
    .splash-icon {
        width: 80px; height: 80px;
        margin-bottom: 24px;
        opacity: 0.9;
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
    }
    
    .splash-title {
        font-size: 32px;
        font-weight: 600;
        letter-spacing: -0.5px;
        margin-bottom: 8px;
    }

    .splash-subtitle {
        font-size: 14px;
        font-weight: 400;
        color: var(--text-secondary);
        max-width: 280px;
        text-align: center;
        line-height: 1.4;
        margin-bottom: 24px;
    }
    
    .splash-status {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    
    .splash-dots {
        display: inline-flex; gap: 4px;
        margin-left: 8px;
    }
    .splash-dots span {
        width: 4px; height: 4px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: pulse 1.4s infinite;
    }
    .splash-dots span:nth-child(2) { animation-delay: 0.2s; }
    .splash-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse {
        0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
        40% { opacity: 1; transform: scale(1); }
    }

    /* === MAIN HUD === */
    .hud {
        position: fixed; inset: 0; z-index: 20;
        pointer-events: none;
        padding: max(20px, var(--safe-top)) 24px max(20px, var(--safe-bottom));
        display: flex; flex-direction: column;
        justify-content: space-between;
    }

    .hud-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .location-block {
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 20px;
        padding: 16px 20px;
        border: 1px solid var(--separator);
    }
    
    .location-coords {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -1px;
        line-height: 1;
    }
    
    .location-status {
        font-size: 11px;
        font-weight: 600;
        color: var(--success);
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .status-dot {
        width: 6px; height: 6px;
        background: var(--success);
        border-radius: 50%;
        animation: blink 2s infinite;
    }
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    .weather-block {
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 20px;
        padding: 16px 20px;
        border: 1px solid var(--separator);
        text-align: right;
    }
    
    .weather-temp {
        font-size: 36px;
        font-weight: 300;
        letter-spacing: -2px;
        line-height: 1;
    }
    
    .weather-details {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-top: 6px;
        letter-spacing: 0.3px;
    }

    .hud-bottom {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }

    .aircraft-count {
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 16px;
        padding: 12px 16px;
        border: 1px solid var(--separator);
    }
    
    .count-number {
        font-size: 32px;
        font-weight: 600;
        letter-spacing: -1px;
        line-height: 1;
    }
    
    .count-label {
        font-size: 10px;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-top: 4px;
    }

    .count-range {
        font-size: 10px;
        font-weight: 500;
        color: var(--text-tertiary);
        margin-top: 2px;
    }

    .empty-state {
        display: none;
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 16px;
        padding: 14px 18px;
        border: 1px solid var(--separator);
        font-size: 13px;
        color: var(--text-secondary);
        max-width: 200px;
        line-height: 1.4;
    }
    .empty-state.show {
        display: block;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        pointer-events: auto;
    }

    .action-btn {
        width: 56px; height: 56px;
        border-radius: 50%;
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border: 1px solid var(--separator);
        color: var(--text-primary);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        transition: transform var(--transition-fast), background var(--transition-fast);
    }
    .action-btn:active { transform: scale(0.92); }
    .action-btn:hover { background: var(--surface-elevated); }
    
    .action-btn svg {
        width: 22px; height: 22px;
        opacity: 0.9;
    }

    .action-btn.danger { background: rgba(255, 69, 58, 0.2); border-color: rgba(255, 69, 58, 0.3); }
    .action-btn.danger svg { color: var(--danger); }

    /* === RESET BUTTON === */
    .reset-btn {
        position: fixed;
        bottom: calc(100px + var(--safe-bottom));
        right: 24px;
        width: 48px; height: 48px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        color: var(--bg);
        display: none;
        align-items: center; justify-content: center;
        cursor: pointer;
        z-index: 80;
        pointer-events: auto;
        box-shadow: 0 4px 24px var(--accent-glow);
        transition: transform var(--transition-fast), opacity var(--transition-fast);
    }
    .reset-btn:active { transform: scale(0.92); }
    .reset-btn svg { width: 20px; height: 20px; }

    /* === COCKPIT VIEW === */
    .cockpit-hud {
        position: fixed; inset: 0;
        pointer-events: none;
        z-index: 30;
        padding: max(20px, var(--safe-top)) 20px max(20px, var(--safe-bottom));
        display: flex; flex-direction: column;
        justify-content: space-between;
    }

    .cockpit-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
    }

    .callsign-block {
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 20px;
        padding: 16px 24px;
        border: 1px solid var(--separator);
    }
    
    .callsign {
        font-size: clamp(28px, 7vw, 48px);
        font-weight: 700;
        letter-spacing: -1px;
        line-height: 1;
    }
    
    .aircraft-type {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-primary);
        margin-top: 6px;
    }

    .compass-block {
        width: 72px; height: 72px;
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 50%;
        border: 1px solid var(--separator);
        display: flex; align-items: center; justify-content: center;
        position: relative;
        flex-shrink: 0;
    }
    
    .compass-ring {
        position: absolute; inset: 6px;
        border-radius: 50%;
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .compass-mark {
        position: absolute;
        font-size: 9px;
        font-weight: 700;
        color: var(--text-tertiary);
    }
    .compass-mark.north { top: 2px; left: 50%; transform: translateX(-50%); color: var(--danger); }
    .compass-mark.south { bottom: 2px; left: 50%; transform: translateX(-50%); }
    .compass-mark.east { right: 2px; top: 50%; transform: translateY(-50%); }
    .compass-mark.west { left: 2px; top: 50%; transform: translateY(-50%); }
    
    .compass-plane { width: 28px; height: 28px; opacity: 0.9; }

    .compass-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .sound-toggle-btn {
        width: 48px; height: 48px;
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 50%;
        border: 1px solid var(--separator);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        pointer-events: auto;
        transition: all var(--transition-fast);
        position: relative;
    }
    .sound-toggle-btn:active { transform: scale(0.92); }
    .sound-toggle-btn:hover { background: var(--surface-elevated); }
    .sound-toggle-btn svg { 
        width: 22px; height: 22px; 
        color: var(--text-primary);
        opacity: 0.9;
        transition: all var(--transition-fast);
    }
    .sound-toggle-btn.active { 
        background: rgba(52, 199, 89, 0.2);
        border-color: rgba(52, 199, 89, 0.4);
    }
    .sound-toggle-btn.active svg { 
        color: var(--success);
        opacity: 1;
    }

    .cockpit-bottom {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        position: relative;
        pointer-events: none;
    }

    .data-card {
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-radius: 20px;
        padding: 16px 20px;
        border: 1px solid var(--separator);
    }
    .data-card.right { text-align: right; }
    
    .data-label {
        font-size: 10px;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-bottom: 4px;
    }
    
    .data-value {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -1px;
        line-height: 1;
    }
    
    .data-unit {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-left: 2px;
    }
    
    .data-row { margin-top: 16px; }

    .crosshair {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 200px; height: 60px;
        z-index: 25;
        opacity: 0.4;
        pointer-events: none;
    }
    .crosshair svg path, .crosshair svg circle {
        stroke: rgba(232, 232, 235, 0.7);
        stroke-width: 1.5;
        fill: none;
    }
    .crosshair svg circle { fill: rgba(232, 232, 235, 0.7); }

    .back-btn {
        position: absolute;
        bottom: calc(100% + 12px);
        right: 0;
        background: var(--surface);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border: 1px solid var(--separator);
        color: var(--text-primary);
        padding: 12px 20px;
        border-radius: 50px;
        font-family: 'Space Mono', monospace;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        z-index: 100;
        pointer-events: auto;
        display: flex; align-items: center; gap: 8px;
        transition: transform var(--transition-fast), background var(--transition-fast);
    }
    .back-btn:active { transform: scale(0.95); }
    .back-btn:hover { background: var(--surface-elevated); }
    .back-btn svg { width: 14px; height: 14px; }

    /* === SETTINGS PANEL === */
    .settings-overlay {
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        z-index: 299;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition-medium);
    }
    .settings-overlay.open { opacity: 1; pointer-events: auto; }

    .settings-panel {
        position: fixed;
        top: 0; right: 0;
        width: 380px; max-width: 90vw;
        height: 100vh; height: 100dvh;
        background: rgba(22, 22, 26, 0.97);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        z-index: 300;
        transform: translateX(100%);
        transition: transform var(--transition-medium);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: var(--safe-top);
        padding-bottom: max(80px, var(--safe-bottom));
    }
    .settings-panel.open { transform: translateX(0); }

    .settings-header {
        padding: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--separator);
    }
    
    .settings-title {
        font-size: 20px;
        font-weight: 600;
    }
    
    .settings-done {
        background: none;
        border: none;
        color: var(--accent);
        font-family: inherit;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        margin: -8px -16px;
    }

    .settings-section {
        padding: 24px;
        border-bottom: 1px solid var(--separator);
    }
    
    .section-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 0.5px;
        text-transform: uppercase;
        margin-bottom: 16px;
    }

    .option-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .option-item {
        background: var(--surface-elevated);
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
    }
    .option-item:hover { background: rgba(60, 60, 67, 0.6); }
    .option-item.selected {
        background: var(--accent-soft);
        border-color: rgba(110, 159, 255, 0.4);
        color: var(--accent);
    }

    .range-chips {
        display: flex;
        gap: 8px;
    }
    
    .range-chip {
        flex: 1;
        background: var(--surface-elevated);
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 14px 12px;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .range-chip:hover { background: rgba(60, 60, 67, 0.6); }
    .range-chip.selected {
        background: var(--accent);
        color: var(--bg);
    }

    .toggle-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-elevated);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 8px;
    }
    
    .toggle-label {
        font-size: 16px;
        font-weight: 500;
    }
    
    .toggle-switch {
        width: 51px; height: 31px;
        background: rgba(120, 120, 128, 0.32);
        border-radius: 31px;
        position: relative;
        cursor: pointer;
        transition: background var(--transition-fast);
    }
    .toggle-switch.active { background: var(--success); }
    
    .toggle-knob {
        width: 27px; height: 27px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px; left: 2px;
        transition: transform var(--transition-fast);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch.active .toggle-knob { transform: translateX(20px); }

    /* === OFFLINE OVERLAY === */
    .offline-overlay {
        position: fixed; inset: 0;
        background: var(--bg);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .offline-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 1px;
        margin-bottom: 24px;
    }
    
    .wake-btn {
        background: var(--accent);
        border: none;
        color: var(--bg);
        padding: 14px 32px;
        border-radius: 50px;
        font-family: inherit;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition-fast);
    }
    .wake-btn:active { transform: scale(0.95); }

    /* === TOAST NOTIFICATIONS === */
    .toast {
        position: fixed;
        bottom: calc(100px + var(--safe-bottom));
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--surface-elevated);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border: 1px solid var(--separator);
        border-radius: 16px;
        padding: 14px 24px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        z-index: 9000;
        opacity: 0;
        transition: all var(--transition-medium);
        pointer-events: none;
        text-align: center;
        max-width: 90vw;
    }
    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    /* === SETTINGS SWIPE HANDLE === */
    .settings-handle {
        width: 36px;
        height: 4px;
        background: var(--text-tertiary);
        border-radius: 2px;
        margin: 0 auto 16px;
    }
</style>
</head>
<body>
    <div class="splash-screen" id="splashScreen">
        <svg class="splash-icon" viewBox="-10 -10 120 120" fill="#e8e8eb">
            <path d="M60.494,49.332l35.654,5.811V46.69l-10.494-3.753c0.046-1.388-0.175-4.873-3.474-5.502c0,0-4.388-1.138-4.956,2.487l-2.967-1.061c0.069-1.229-0.006-5.029-3.465-5.69c0,0-4.528-1.172-4.979,2.671l-7.696-2.753V19.224c-0.528-7.923-7.395-8.188-7.395-8.188s-6.867,0.265-7.395,8.188v13.866l-8.167,2.921c-0.336-4.047-4.998-2.839-4.998-2.839c-3.639,0.695-3.532,4.867-3.454,5.861l-2.957,1.058c-0.46-3.824-4.977-2.655-4.977-2.655c-3.445,0.658-3.533,4.43-3.466,5.674L5.295,46.69v8.452l35.655-5.811l2.377,4.227c0,0,0.264,20.864,2.905,24.562l-12.941,6.075l0.265,5.545h34.333l0.265-5.545L55.212,78.12c2.642-3.697,2.905-24.562,2.905-24.562L60.494,49.332z"/>
        </svg>
        <div class="splash-title">PlanePatrol</div>
        <div class="splash-subtitle">Live aircraft tracking. Tap any plane to enter cockpit view.</div>
        <div class="splash-status" id="splashStatus">
            Locating<span class="splash-dots"><span></span><span></span><span></span></span>
        </div>
    </div>

    <div class="offline-overlay" id="offlineOverlay">
        <div class="offline-title">SYSTEMS OFFLINE</div>
        <button class="wake-btn" id="wakeBtn">Resume Tracking</button>
    </div>

    <div id="main-view">
        <div id="map"></div>
        
        <div class="hud">
            <div class="hud-top">
                <div class="location-block">
                    <div class="location-coords" id="locationDisplay">--</div>
                    <div class="location-status">
                        <span class="status-dot"></span>
                        <span id="statusDisplay">Acquiring</span>
                    </div>
                </div>
                
                <div class="weather-block">
                    <div class="weather-temp" id="wxTemp">--°</div>
                    <div class="weather-details">
                        <span id="wxCond">Loading</span> · <span id="wxWind">--</span> kt
                    </div>
                </div>
            </div>

            <div class="hud-bottom">
                <div class="aircraft-count">
                    <div class="count-number" id="planeCount">0</div>
                    <div class="count-label">Aircraft</div>
                    <div class="count-range" id="rangeLabel">within 5 mi</div>
                </div>
                <div class="empty-state" id="emptyState">
                    No aircraft in range. Try widening the radius or pick a busier airport.
                </div>

                <div class="action-buttons">
                    <button class="action-btn danger" id="quitBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6M12 16v.01"/>
                        </svg>
                    </button>
                    <button class="action-btn" id="settingsBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <button class="reset-btn" id="resetBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M12 2a10 10 0 1 0 10 10"/>
                <path d="M22 2v6h-6"/>
            </svg>
        </button>

    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <div id="cockpit-view">
        <div id="cockpitMap"></div>
        
        <div class="crosshair">
            <svg viewBox="0 0 200 60">
                <path d="M 30,30 L 80,30"/>
                <path d="M 120,30 L 170,30"/>
                <circle cx="100" cy="30" r="3"/>
            </svg>
        </div>

        <div class="cockpit-hud">
            <div class="cockpit-top">
                <div class="callsign-block">
                    <div class="callsign" id="cCallsign">---</div>
                    <div class="aircraft-type" id="cType">Unknown Aircraft</div>
                </div>
                
                <div class="compass-wrapper">
                    <div class="compass-block">
                        <div class="compass-ring" id="compassRing">
                            <span class="compass-mark north">N</span>
                            <span class="compass-mark east">E</span>
                            <span class="compass-mark south">S</span>
                            <span class="compass-mark west">W</span>
                        </div>
                        <svg class="compass-plane" viewBox="0 0 24 24" fill="#e8e8eb">
                            <path d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                        </svg>
                    </div>
                    <button class="sound-toggle-btn" id="cockpitSoundToggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="cockpit-bottom">
                <div class="data-card">
                    <div class="data-label">Altitude</div>
                    <div class="data-value"><span id="cAlt">0</span><span class="data-unit">ft</span></div>
                    <div class="data-row">
                        <div class="data-label">Distance</div>
                        <div class="data-value"><span id="cDist">0.0</span><span class="data-unit">mi</span></div>
                    </div>
                </div>
                
                <button class="back-btn" id="backBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>
                
                <div class="data-card right">
                    <div class="data-label">Speed</div>
                    <div class="data-value"><span id="cSpd">0</span><span class="data-unit">kts</span></div>
                    <div class="data-row">
                        <div class="data-label">Status</div>
                        <div class="data-value" id="cStatus" style="font-size: 18px;">Cruising</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-handle" id="settingsHandle"></div>
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="settings-done" id="settingsDone">Done</button>
        </div>

        <div class="settings-section">
            <div class="section-title">Location</div>
            <div class="option-list">
                <div class="option-item selected" id="optGeo">My Location</div>
                <div class="option-item" id="optJFK">New York (JFK)</div>
                <div class="option-item" id="optLAX">Los Angeles (LAX)</div>
                <div class="option-item" id="optATL">Atlanta (ATL)</div>
            </div>
        </div>

        <div class="settings-section">
            <div class="section-title">Range</div>
            <div class="range-chips">
                <div class="range-chip" data-range="3">3 mi</div>
                <div class="range-chip selected" data-range="5">5 mi</div>
                <div class="range-chip" data-range="10">10 mi</div>
                <div class="range-chip" data-range="20">20 mi</div>
            </div>
        </div>

        <div class="settings-section">
            <div class="toggle-row">
                <span class="toggle-label">Weather Radar</span>
                <div class="toggle-switch active" id="radarToggle">
                    <div class="toggle-knob"></div>
                </div>
            </div>
            <div class="toggle-row">
                <span class="toggle-label">Light Theme</span>
                <div class="toggle-switch" id="themeToggle">
                    <div class="toggle-knob"></div>
                </div>
            </div>
        </div>
    </div>

<script>
// === CONFIGURATION ===
const CONFIG = {
    API_PLANES: 'https://api.airplanes.live/v2/point/',
    API_WX_POINTS: 'https://api.weather.gov/points/',
    RADAR_TILE_URL: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',
    MAP_TILES: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
    SAT_TILES: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    POLL_MS: 5000,
    WX_POLL_MS: 900000,
    ANIMATION_DURATION: 5000,
    KNOTS_TO_KMH: 1.852,
    LOCATIONS: {
        JFK: { name: 'JFK', lat: 40.6413, lon: -73.7781 },
        LAX: { name: 'LAX', lat: 33.9416, lon: -118.4085 },
        ATL: { name: 'ATL', lat: 33.6407, lon: -84.4277 }
    }
};

// Aircraft database (comprehensive)
const AIRCRAFT_TYPES = {
    // --- AIRBUS ---
    "A318": "Airbus A318", "A319": "Airbus A319", "A320": "Airbus A320", "A20N": "Airbus A320neo",
    "A321": "Airbus A321", "A21N": "Airbus A321neo", "A332": "Airbus A330-200", "A333": "Airbus A330-300",
    "A338": "Airbus A330-800", "A339": "Airbus A330-900", "A343": "Airbus A340-300", "A346": "Airbus A340-600",
    "A359": "Airbus A350-900", "A35K": "Airbus A350-1000", "A388": "Airbus A380", "A306": "Airbus A300-600",
    "A3ST": "Airbus Beluga", "BCS1": "Airbus A220-100", "BCS3": "Airbus A220-300",
    // --- BOEING ---
    "B737": "Boeing 737-700", "B738": "Boeing 737-800", "B739": "Boeing 737-900",
    "B38M": "Boeing 737 MAX 8", "B39M": "Boeing 737 MAX 9", "B744": "Boeing 747-400", "B748": "Boeing 747-8",
    "B752": "Boeing 757-200", "B753": "Boeing 757-300", "B763": "Boeing 767-300", "B764": "Boeing 767-400",
    "B772": "Boeing 777-200", "B77L": "Boeing 777-200LR", "B77W": "Boeing 777-300ER", "B77X": "Boeing 777X",
    "B788": "Boeing 787-8", "B789": "Boeing 787-9", "B78X": "Boeing 787-10",
    // --- CARGO & LEGACY ---
    "MD11": "McDonnell Douglas MD-11", "DC10": "McDonnell Douglas DC-10", "B712": "Boeing 717-200",
    "B703": "Boeing 707 / KC-135", "B722": "Boeing 727-200",
    // --- REGIONAL & COMMUTER ---
    "E170": "Embraer E170", "E75L": "Embraer E175", "E75S": "Embraer E175", "E190": "Embraer E190",
    "E195": "Embraer E195", "E290": "Embraer E190-E2", "E295": "Embraer E195-E2",
    "ERJ3": "Embraer ERJ-135", "ERJ4": "Embraer ERJ-145",
    "CRJ1": "CRJ-100", "CRJ2": "CRJ-200", "CRJ7": "CRJ-700", "CRJ9": "CRJ-900", "CL60": "Challenger 600",
    "DH8A": "Dash 8-100", "DH8B": "Dash 8-200", "DH8C": "Dash 8-300", "DH8D": "Q400",
    "AT72": "ATR 72", "AT75": "ATR 72-500", "AT76": "ATR 72-600", "AT45": "ATR 42-500", "AT46": "ATR 42-600",
    // --- BUSINESS JETS & UTILITY ---
    "E50P": "Phenom 100", "E55P": "Phenom 300", "LJ35": "Learjet 35", "LJ45": "Learjet 45",
    "LJ60": "Learjet 60", "LJ75": "Learjet 75", "H25B": "Hawker 800XP", "GALX": "Gulfstream G200",
    "EA50": "Eclipse 500", "GLF4": "Gulfstream IV", "GLF5": "Gulfstream V", "GLF6": "Gulfstream G650",
    "G280": "Gulfstream G280", "C510": "Citation Mustang", "C525": "Citation Jet", "C56X": "Citation Excel",
    "C680": "Citation Sovereign", "C700": "Citation Longitude", "CL30": "Challenger 300", "CL35": "Challenger 350",
    "GLEX": "Global Express", "GL75": "Global 7500", "FA7X": "Falcon 7X", "FA8X": "Falcon 8X",
    "F2TH": "Falcon 2000", "PC24": "Pilatus PC-24", "HDJT": "HondaJet",
    // --- TURBOPROPS ---
    "TBM7": "TBM 700", "TBM8": "TBM 850", "TBM9": "TBM 900",
    "BE9L": "King Air C90", "BE20": "King Air 200", "B350": "King Air 350", "PC12": "Pilatus PC-12",
    // --- GENERAL AVIATION ---
    "C150": "Cessna 150", "C152": "Cessna 152", "C172": "Cessna 172", "C182": "Cessna 182", "C208": "Cessna Caravan",
    "PA28": "Piper Cherokee", "PA34": "Piper Seneca", "PA44": "Piper Seminole",
    "SR20": "Cirrus SR20", "SR22": "Cirrus SR22", "SF50": "Vision Jet",
    "BE36": "Bonanza", "BE58": "Baron", "DA40": "Diamond Star", "DA42": "Twin Star", "DA62": "Diamond DA62",
    // --- EXPERIMENTAL ---
    "RV6": "Van's RV-6", "RV7": "Van's RV-7", "RV8": "Van's RV-8", "RV10": "Van's RV-10", "RV12": "Van's RV-12", "ICON": "ICON A5",
    // --- MILITARY JETS & CARGO ---
    "C130": "C-130 Hercules", "C30J": "C-130J Super Hercules", "C17": "C-17 Globemaster",
    "K35R": "KC-135 Stratotanker", "F16": "F-16 Fighting Falcon", "F18": "F/A-18 Hornet",
    "F22": "F-22 Raptor", "F35": "F-35 Lightning II", "TEX2": "T-6 Texan II", "T38": "T-38 Talon",
    "T45": "T-45 Goshawk", "L39": "L-39 Albatros", "C5": "C-5 Galaxy", "C5M": "C-5M Super Galaxy",
    "A400": "A400M Atlas", "K46": "KC-46 Pegasus",
    // --- BOMBERS & SPECIAL MISSION ---
    "B52": "B-52 Stratofortress", "B1": "B-1 Lancer", "B2": "B-2 Spirit", "A10": "A-10 Thunderbolt II",
    "E3TF": "E-3 Sentry (AWACS)", "E3CF": "E-3 Sentry (AWACS)", "E6": "E-6 Mercury", "E2": "E-2 Hawkeye",
    "P8": "P-8 Poseidon", "C135": "RC-135 Rivet Joint", "U2": "U-2 Dragon Lady",
    // --- HELICOPTERS ---
    "R44": "Robinson R44", "R66": "Robinson R66", "B06": "Bell 206", "B407": "Bell 407",
    "EC35": "H135/EC135", "S76": "Sikorsky S-76", "S92": "Sikorsky S-92", "AW13": "AW139",
    "H64": "AH-64 Apache", "H47": "CH-47 Chinook", "H53": "CH-53 Sea Stallion", "V22": "V-22 Osprey",
    "TIGR": "Eurocopter Tiger", "NH90": "NH90", "UH1": "UH-1 Huey", "UH1N": "UH-1N Twin Huey",
    "UH1Y": "UH-1Y Venom", "GAZL": "Gazelle", "LYNX": "AW159 Wildcat", "H500": "MD 500 / Little Bird",
    "EXPL": "MD Explorer", "B429": "Bell 429", "EN48": "Enstrom 480", "EH10": "AW101 Merlin",
    "AS32": "AS332 Super Puma", "EC25": "EC225 Super Puma", "AS65": "AS365 Dauphin",
    "H60": "Black Hawk / Seahawk", "EC45": "H145 / Lakota", "AS50": "H125 / AS350"
};
// === ASMR AUDIO ENGINE ===
class EngineAudio {
    constructor() {
        this.ctx = null;
        this.activeNodes = [];
        this.masterGain = null;
        this.fading = false;
        // LFO for subtle stereo drifting (ASMR key feature)
        this.driftOsc = null; 
        this.stopTimer = null; // Track the cleanup timer
    }

    init() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            
            // Compressor keeps levels lush but consistent (radio voice effect)
            const compressor = this.ctx.createDynamicsCompressor();
            compressor.threshold.value = -20;
            compressor.knee.value = 40;
            compressor.ratio.value = 12;
            compressor.attack.value = 0;
            compressor.release.value = 0.25;

            this.masterGain.connect(compressor);
            compressor.connect(this.ctx.destination);
        }
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    }

    // High quality Pink Noise generator (Softer/Airier than Brown)
    createPinkNoise() {
        const bufferSize = this.ctx.sampleRate * 2;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        let b0, b1, b2, b3, b4, b5, b6;
        b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            b0 = 0.99886 * b0 + white * 0.0555179;
            b1 = 0.99332 * b1 + white * 0.0750759;
            b2 = 0.96900 * b2 + white * 0.1538520;
            b3 = 0.86650 * b3 + white * 0.3104856;
            b4 = 0.55000 * b4 + white * 0.5329522;
            b5 = -0.7616 * b5 - white * 0.0168980;
            data[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
            data[i] *= 0.11;
            b6 = white * 0.115926;
        }
        return buffer;
    }

    // Heavy Brown Noise (Deep Rumble)
    createBrownNoise() {
        const bufferSize = this.ctx.sampleRate * 2;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        let lastOut = 0;
        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            data[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = data[i];
            data[i] *= 3.5;
        }
        return buffer;
    }

    play(type) {
        if (!state.soundEnabled) return; // Respect toggle
        this.init();
        this.stop(true); // Stop previous immediately
        
        // Soft fade in for immersion
        this.masterGain.gain.setValueAtTime(0, this.ctx.currentTime);
        this.masterGain.gain.linearRampToValueAtTime(0.6, this.ctx.currentTime + 2.0);
        this.fading = false;

        const nodes = [];
        const now = this.ctx.currentTime;

        // --- GLOBAL STEREO DRIFT (The "floating" sensation) ---
        if (this.ctx.createStereoPanner) {
            const panner = this.ctx.createStereoPanner();
            const lfo = this.ctx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 0.1; // Very slow drift (10 seconds)
            const lfoGain = this.ctx.createGain();
            lfoGain.gain.value = 0.15; // Subtle movement
            
            lfo.connect(lfoGain).connect(panner.pan);
            lfo.start();
            this.masterGain.disconnect();
            this.masterGain.connect(panner).connect(this.ctx.destination);
            nodes.push(lfo, lfoGain, panner);
        }

        if (type === 'heli') {
            // === HELI: Rhythmic hypnotic thumping ===
            
            // 1. The "Whomp" (Filtered Pink Noise)
            const noise = this.ctx.createBufferSource();
            noise.buffer = this.createPinkNoise();
            noise.loop = true;
            
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 250; // Dark sound
            filter.Q.value = 2; // Resonance adds "body" to the whomp

            // The chopping LFO
            const modulator = this.ctx.createOscillator();
            modulator.frequency.value = 5.5; // Chop rate
            modulator.type = 'sine'; // Smoother than saw for ASMR

            // Create a custom pulsing curve for the gain
            const chopper = this.ctx.createGain();
            chopper.gain.value = 0;
            
            // Connect modulation
            modulator.connect(chopper.gain); 
            noise.connect(filter).connect(chopper).connect(this.masterGain);

            // 2. High Turbine Whine (very subtle/distant)
            const osc = this.ctx.createOscillator();
            osc.type = 'sine'; // Pure tone
            osc.frequency.value = 300;
            const oscGain = this.ctx.createGain();
            oscGain.gain.value = 0.03;
            osc.connect(oscGain).connect(this.masterGain);

            noise.start(); modulator.start(); osc.start();
            nodes.push(noise, modulator, osc, filter, chopper);

        } else if (type === 'prop') {
            // === PROP: The "Binaural Beat" Drone ===
            
            // 1. Dual Detuned Oscillators (Creates the throbbing effect)
            const freq = 100;
            const osc1 = this.ctx.createOscillator();
            const osc2 = this.ctx.createOscillator();
            osc1.type = 'sawtooth';
            osc2.type = 'sawtooth';
            
            osc1.frequency.value = freq;
            osc2.frequency.value = freq + 1.5; // 1.5Hz beat frequency (Relaxing theta range)

            // Heavy filtering to remove the "buzz" and keep the "hum"
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 180;
            
            const droneGain = this.ctx.createGain();
            droneGain.gain.value = 0.15;

            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(droneGain).connect(this.masterGain);

            // 2. Wind Flutter
            const noise = this.ctx.createBufferSource();
            noise.buffer = this.createPinkNoise();
            noise.loop = true;
            const noiseGain = this.ctx.createGain();
            noiseGain.gain.value = 0.08;
            noise.connect(noiseGain).connect(this.masterGain);

            osc1.start(); osc2.start(); noise.start();
            nodes.push(osc1, osc2, noise, filter);

        } else {
            // === JET: The "White Noise Machine" (Ultimate Sleep) ===

            // 1. Deep Sub-Bass (The physical rumble)
            const sub = this.ctx.createOscillator();
            sub.type = 'sine';
            sub.frequency.value = 55;
            const subGain = this.ctx.createGain();
            subGain.gain.value = 0.2;
            sub.connect(subGain).connect(this.masterGain);

            // 2. Brown Noise (The Atmosphere)
            const rumble = this.ctx.createBufferSource();
            rumble.buffer = this.createBrownNoise();
            rumble.loop = true;
            const rumbleFilter = this.ctx.createBiquadFilter();
            rumbleFilter.type = 'lowpass';
            rumbleFilter.frequency.value = 350;
            const rumbleGain = this.ctx.createGain();
            rumbleGain.gain.value = 0.5;
            rumble.connect(rumbleFilter).connect(rumbleGain).connect(this.masterGain);

            // 3. Pink Noise (The Air Hiss)
            const air = this.ctx.createBufferSource();
            air.buffer = this.createPinkNoise();
            air.loop = true;
            const airFilter = this.ctx.createBiquadFilter();
            airFilter.type = 'highpass'; // Remove low end, keep hiss
            airFilter.frequency.value = 800;
            const airGain = this.ctx.createGain();
            airGain.gain.value = 0.05; // Very subtle
            
            // Animate the air hiss slightly (turbulence)
            const turbLFO = this.ctx.createOscillator();
            turbLFO.frequency.value = 0.2;
            const turbGain = this.ctx.createGain();
            turbGain.gain.value = 0.02;
            turbLFO.connect(turbGain).connect(airGain.gain);

            air.connect(airFilter).connect(airGain).connect(this.masterGain);

            sub.start(); rumble.start(); air.start(); turbLFO.start();
            nodes.push(sub, rumble, air, turbLFO);
        }

        this.activeNodes = nodes;
    }

    stop(immediate = false) {
        if (!this.ctx) return;
        
        // ** CRITICAL FIX **: Clear any pending cleanup timer from previous fades
        if (this.stopTimer) {
            clearTimeout(this.stopTimer);
            this.stopTimer = null;
        }

        if (immediate) {
            this.masterGain.gain.cancelScheduledValues(this.ctx.currentTime);
            this.masterGain.gain.setValueAtTime(0, this.ctx.currentTime);
            this.activeNodes.forEach(n => {
                try { n.stop(); n.disconnect(); } catch(e){}
            });
            this.activeNodes = [];
            this.fading = false;
            return;
        }

        if (this.fading) return;
        this.fading = true;
        
        const now = this.ctx.currentTime;
        this.masterGain.gain.cancelScheduledValues(now);
        this.masterGain.gain.setValueAtTime(this.masterGain.gain.value, now);
        this.masterGain.gain.exponentialRampToValueAtTime(0.001, now + 2.5); // Long fade out

        // Store this timer ID so we can cancel it if the user clicks another plane quickly
        this.stopTimer = setTimeout(() => {
            this.activeNodes.forEach(n => {
                try { n.stop(); n.disconnect(); } catch(e){}
            });
            this.activeNodes = [];
            this.stopTimer = null;
        }, 2600);
    }
}

 engineAudio = new EngineAudio();

// === STATE ===
const state = {
    lat: null, lon: null, radius: 5,
    map: null, cockpitMap: null,
    planesData: new Map(),
    selectedHex: null, mode: 'radar',
    wxInterval: null, planeInterval: null,
    lastGeoUpdate: 0, lastWxUpdate: 0, lastKnownGeo: null, useGeo: true,
    radarEnabled: true, 
    soundEnabled: false, // Default: Sound is OFF
    lightTheme: false,
    watchId: null, isFetchingPlanes: false, hasLockedLocation: false,
    cachedStationUrl: null, lastAnimateTime: 0,
    // Onboarding flags (persist in localStorage)
    hasSeenPlaneTip: localStorage.getItem('pp-seen-plane-tip') === 'true',
    hasSeenCockpitTip: localStorage.getItem('pp-seen-cockpit-tip') === 'true'
};

// === DOM REFERENCES ===
const DOM = {
    splashScreen: document.getElementById('splashScreen'),
    splashStatus: document.getElementById('splashStatus'),
    mainView: document.getElementById('main-view'),
    cockpitView: document.getElementById('cockpit-view'),
    resetBtn: document.getElementById('resetBtn'),
    locationDisplay: document.getElementById('locationDisplay'),
    statusDisplay: document.getElementById('statusDisplay'),
    planeCount: document.getElementById('planeCount'),
    rangeLabel: document.getElementById('rangeLabel'),
    emptyState: document.getElementById('emptyState'),
    wxTemp: document.getElementById('wxTemp'),
    wxCond: document.getElementById('wxCond'),
    wxWind: document.getElementById('wxWind'),
    cCallsign: document.getElementById('cCallsign'),
    cType: document.getElementById('cType'),
    cAlt: document.getElementById('cAlt'),
    cDist: document.getElementById('cDist'),
    cSpd: document.getElementById('cSpd'),
    cStatus: document.getElementById('cStatus'),
    settingsPanel: document.getElementById('settingsPanel'),
    settingsOverlay: document.getElementById('settingsOverlay'),
    radarToggle: document.getElementById('radarToggle'),
    toast: document.getElementById('toast')
};

// === UTILITY FUNCTIONS ===
function getZoomForRadius(r) {
    if (r <= 3) return 13;
    if (r <= 5) return 12;
    if (r <= 10) return 11;
    if (r <= 20) return 10;
    return 9;
}

function calcDist(lat1, lon1, lat2, lon2) {
    const R = 3958.8;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// === HAPTIC FEEDBACK ===
function haptic(style = 'light') {
    if ('vibrate' in navigator) {
        const patterns = { light: 10, medium: 20, heavy: 30 };
        navigator.vibrate(patterns[style] || 10);
    }
}

// === TOAST NOTIFICATIONS ===
let toastTimeout = null;
function showToast(message, duration = 3000) {
    if (toastTimeout) clearTimeout(toastTimeout);
    DOM.toast.textContent = message;
    DOM.toast.classList.add('show');
    toastTimeout = setTimeout(() => {
        DOM.toast.classList.remove('show');
    }, duration);
}

// === THEME TOGGLE ===
function setTheme(isLight) {
    state.lightTheme = isLight;
    document.documentElement.classList.toggle('light-theme', isLight);
    document.getElementById('themeToggle').classList.toggle('active', isLight);
    localStorage.setItem('planepatrol-theme', isLight ? 'light' : 'dark');
}

function getProjectedPoint(lat, lon, bear, distKm) {
    const R = 6371;
    const d = distKm / R;
    const rLat = lat * Math.PI / 180;
    const rLon = lon * Math.PI / 180;
    const rBear = bear * Math.PI / 180;
    const nLat = Math.asin(Math.sin(rLat) * Math.cos(d) + Math.cos(rLat) * Math.sin(d) * Math.cos(rBear));
    const nLon = rLon + Math.atan2(Math.sin(rBear) * Math.sin(d) * Math.cos(rLat), Math.cos(d) - Math.sin(rLat) * Math.sin(nLat));
    return [nLon * 180 / Math.PI, nLat * 180 / Math.PI];
}

function getAircraftTypeName(typeCode) {
    if (!typeCode) return "Unknown Aircraft";
    return AIRCRAFT_TYPES[typeCode] || typeCode;
}

function getIconType(t, category) {
    if (!t) return 'plane-jet';
    const type = t.toUpperCase();
    
    // Helicopters
    if (category === 'A7' || category === 'H' || type === 'HEL') return 'heli-icon';

    // Fighters & Attack
    const fighters = ['F16','F18','F22','F35','EUFI','RAFA','GRIP','TORN','T38','T45','L39','A10','F15','F14',
        'MIG29','SU27','SU35','SU57','J20','J31','J10','JF17','M2000','M4000','F4','F5','F86',
        'MIG15','MIG17','MIG19','MIG21','MIG23','MIG25','MIG31','SU24','SU25','SU30','SU34'];
    if (fighters.includes(type)) return 'plane-fighter';

    // Heavy aircraft (widebodies, military cargo, tankers)
    const heavies = ['B744','B748','A388','A343','A346','C5','C5M','B52','C17','IL76','AN124','A124',
        'DC10','MD11','K35R','C135','E3TF','E3CF','B772','B77W','B77L','B788','B789','B78X',
        'A359','A35K','A332','A333','A338','A339'];
    if (heavies.includes(type)) return 'plane-heavy';

    // Props & Turboprops
    const props = [
        'C130','C30J','A400','C295','CN35', // Military cargo
        'AT72','AT75','AT76','AT45','AT46', // ATR
        'DH8A','DH8B','DH8C','DH8D', // Dash 8
        'PC12', 'TBM7','TBM8','TBM9', // Turboprops
        'BE9L','BE20','B350','BE36','BE58', // King Air / Beechcraft
        'C208','C172','C182','C150','C152', // Cessna props
        'PA28','PA34','PA44','PA46', // Piper
        'SR20','SR22', // Cirrus props
        'DA40','DA42','DA62', // Diamond
        'RV6','RV7','RV8','RV10','RV12' // Vans experimental
    ];
    if (props.includes(type)) return 'plane-prop';

    // Catch-all prop prefixes
    if (type.startsWith('C1') && type !== 'C17') return 'plane-prop';
    if (type.startsWith('PA')) return 'plane-prop';

    // Default: jet
    return 'plane-jet';
}

function getFlightPhase(p) {
    if (p.alt_baro === 'ground') return 'Taxiing';
    const rate = p.baro_rate || 0;
    if (rate > 500) return 'Climbing';
    if (rate < -500) return 'Descending';
    return 'Cruising';
}

// === MAP INITIALIZATION ===
function initMap() {
    try {
        state.map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'osm': { type: 'raster', tiles: [CONFIG.MAP_TILES], tileSize: 256 }},
                layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
            },
            center: [state.lon || -98.5, state.lat || 39.8],
            zoom: 11,
            attributionControl: false
        });

        state.map.on('load', () => {
            // Radar layer
            state.map.addSource('radar', { type: 'raster', tiles: [CONFIG.RADAR_TILE_URL], tileSize: 256 });
            state.map.addLayer({ id: 'radar-layer', type: 'raster', source: 'radar', paint: { 'raster-opacity': 0.4 }});

            // Load plane icons
            // Note: Map has invert(100%) filter, so dark icons appear light
            const iconColor = "#000000";
            const loadIcon = (name, svg) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 64; canvas.height = 64;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 64, 64);
                    state.map.addImage(name, ctx.getImageData(0, 0, 64, 64));
                };
                img.src = 'data:image/svg+xml;base64,' + btoa(svg);
            };

            loadIcon('plane-jet', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-5 -10 110 135"><path fill="${iconColor}" d="m44.6 80.1c-0.3-4.7-0.6-13.2-1-20.5-0-0.6-0.3-1.2-0.9-1.6-0.5-0.4-1.2-0.5-1.8-0.4-7.4 1.8-28.1 6.8-28.1 6.8-0.5 0.1-1.1 0-1.5-0.3-0.4-0.3-0.7-0.8-0.7-1.4v-3.7c0-1.7 0.9-3.3 2.4-4.2 0 0 18.3-10.2 26.2-14.7 2.2-1.2 3.5-3.5 3.5-6-0.1-8 0.2-13.4 1-18 0.1-0.3 0.2-0.7 0.3-1 0 0 2.4-9 5.5-9s5.5 9 5.5 9c0.1 0.3 0.2 0.7 0.3 1 0.8 4.6 1 10 1 18-0 2.5 1.3 4.8 3.5 6 7.9 4.4 26.2 14.7 26.2 14.7 1.5 0.8 2.4 2.4 2.4 4.2v3.7c0 0.5-0.2 1-0.7 1.4-0.4 0.3-1 0.4-1.5 0.3 0 0-20.7-5-28.1-6.8-0.6-0.2-1.3 0-1.8 0.4-0.5 0.4-0.8 1-0.9 1.6-0.3 7.3-0.7 15.9-1 20.5l11.1 7.3c0.4 0.3 0.7 0.7 0.8 1.1l0.4 2c0.1 0.3-0 0.6-0.3 0.9-0.2 0.2-0.5 0.3-0.8 0.3l-12.7-1.8c-0.1 0.2-0.3 0.5-0.5 0.7l-1.7 2.4c-0.3 0.5-0.8 0.7-1.4 0.7-0.1 0-0.2-0-0.3-0s-0.2 0-0.3 0c-0.6 0-1.1-0.3-1.4-0.7l-1.7-2.4c-0.2-0.2-0.3-0.5-0.5-0.7l-12.7 1.8c-0.3 0-0.6-0.1-0.8-0.3-0.2-0.2-0.3-0.5-0.3-0.9l0.4-2c0.1-0.5 0.4-0.9 0.8-1.1l11.1-7.3z"/></svg>`);
            loadIcon('plane-fighter', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="${iconColor}" d="M50 5 L60 30 L95 70 L95 80 L60 60 L60 85 L70 95 L30 95 L40 85 L40 60 L5 80 L5 70 L40 30 Z"/></svg>`);
            loadIcon('plane-heavy', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-10 -10 120 120"><path fill="${iconColor}" d="M60.494,49.332l35.654,5.811V46.69l-10.494-3.753c0.046-1.388-0.175-4.873-3.474-5.502c0,0-4.388-1.138-4.956,2.487l-2.967-1.061c0.069-1.229-0.006-5.029-3.465-5.69c0,0-4.528-1.172-4.979,2.671l-7.696-2.753V19.224c-0.528-7.923-7.395-8.188-7.395-8.188s-6.867,0.265-7.395,8.188v13.866l-8.167,2.921c-0.336-4.047-4.998-2.839-4.998-2.839c-3.639,0.695-3.532,4.867-3.454,5.861l-2.957,1.058c-0.46-3.824-4.977-2.655-4.977-2.655c-3.445,0.658-3.533,4.43-3.466,5.674L5.295,46.69v8.452l35.655-5.811l2.377,4.227c0,0,0.264,20.864,2.905,24.562l-12.941,6.075l0.265,5.545h34.333l0.265-5.545L55.212,78.12c2.642-3.697,2.905-24.562,2.905-24.562L60.494,49.332z"/></svg>`);
            loadIcon('plane-prop', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="${iconColor}" d="M96.5,32.5c-0.2-0.9-3.2-0.7-4.1-0.8c-1-0.1-22.5-0.6-22.5-0.6l-15.1,0.5c0,0-0.1-8-0.8-9.9c-0.5-1.3-0.9-2.2-2.2-2.1l-0.2,0c-0.4-1.8-1.2-3-1.6-3s-1.2,1.3-1.6,3l-0.2,0c-1.3-0.1-1.7,0.8-2.2,2.1c-0.7,1.8-0.8,9.9-0.8,9.9l-15.1-0.5c0,0-21.4,0.6-22.5,0.6c-1,0.1-3.9-0.1-4.1,0.8c-0.3,1.2-0.1,4.6-0.1,5.9c0,0.9,0,3.6,0,3.6h2l24.7,4.4L45.7,47h0.1L48,69.8c0,0-9.7,1-10.4,1c-0.8,0.1-1.3,0.2-1.6,0.4c-0.3,0.2-0.5,0.5-0.6,0.8c-0.1,0.3,0.1,3.6,0.1,4c0,0.4,0.2,0.9,0.6,1.3c0.4,0.4,0.9,0.8,1.7,0.9c0.8,0.1,9.4,1.4,9.5,1.4c0.1,0,1.8-3,1.8-3l1,6.9l1-6.9c0,0,1.7,3,1.8,3s8.7-1.3,9.5-1.4c0.7-0.1,1.3-0.4,1.7-0.9c0.4-0.4,0.6-0.9,0.6-1.3c0-0.4,0.2-3.7,0.1-4c-0.1-0.3-0.3-0.6-0.6-0.8c-0.3-0.2-0.8-0.4-1.6-0.5C61.6,70.8,52,69.7,52,69.7l2.4-22.9l15.4-0.5L94.5,42h2c0,0,0-2.7,0-3.6C96.6,37.1,96.7,33.7,96.5,32.5z"/></svg>`);
            loadIcon('heli-icon', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-42.35 -84.7 931.7 1143.45"><g transform="rotate(0 423.5 487)"><path fill="${iconColor}" d="M662 55l-125 125c-36,-185 -188,-171 -217,11l-136 -136c-19,-19 -46,8 -26,27l158 159c0,45 8,91 29,131l-187 188c-20,19 7,46 26,27l183 -182c7,9 16,16 25,21l0 253 -115 77 0 44 121 -54 64 0 120 54 0 -44 -114 -77 0 -253c6,-4 13,-9 19,-15l175 176c19,19 46,-8 27,-27l-179 -179c26,-45 35,-101 33,-152l146 -147c19,-19 -8,-46 -27,-27z"/></g></svg>`);

            // Data sources
            state.map.addSource('planes', { type: 'geojson', data: { type: 'FeatureCollection', features: [] }});
            state.map.addSource('flight-trails', { type: 'geojson', data: { type: 'FeatureCollection', features: [] }});
            state.map.addSource('flight-predictions', { type: 'geojson', data: { type: 'FeatureCollection', features: [] }});
            state.map.addSource('user-location', { type: 'geojson', data: { type: 'FeatureCollection', features: [] }});

            // User location - colors inverted by map filter
            state.map.addLayer({
                id: 'user-location-dot', type: 'circle', source: 'user-location',
                paint: {
                    'circle-radius': 10,
                    'circle-color': '#916000',
                    'circle-stroke-width': 3,
                    'circle-stroke-color': 'rgba(10, 10, 8, 0.9)',
                    'circle-opacity': 0.95
                }
            });

            // Flight trails (behind aircraft) - color inverted by map filter
            state.map.addLayer({
                id: 'flight-trails-layer', type: 'line', source: 'flight-trails',
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 
                    'line-color': 'rgba(0, 0, 0, 0.5)',
                    'line-width': 2,
                    'line-blur': 1
                }
            });

            // Flight prediction lines (ahead of aircraft) - dashed
            state.map.addLayer({
                id: 'flight-predictions-layer', type: 'line', source: 'flight-predictions',
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 
                    'line-color': 'rgba(0, 80, 180, 0.4)',
                    'line-width': 2,
                    'line-dasharray': [2, 4]
                }
            });

            // Plane icons
            state.map.addLayer({
                id: 'planes-layer', type: 'symbol', source: 'planes',
                layout: {
                    'icon-image': ['get', 'icon'],
                    'icon-size': ['interpolate', ['linear'], ['zoom'], 9, 0.6, 11, 0.8, 13, 1],
                    'icon-allow-overlap': true, 'icon-ignore-placement': true,
                    'icon-rotate': ['get', 'rotation'], 'icon-rotation-alignment': 'map'
                },
                paint: { 'icon-opacity': 0.85 }
            });

            // Click handlers - go directly to cockpit mode
            state.map.on('click', 'planes-layer', (e) => {
                if (e.features.length > 0) {
                    haptic('light');
                    enterCockpitMode(e.features[0].properties.hex);
                }
            });
            state.map.on('mouseenter', 'planes-layer', () => state.map.getCanvas().style.cursor = 'pointer');
            state.map.on('mouseleave', 'planes-layer', () => state.map.getCanvas().style.cursor = '');

            // Map click for custom location
            state.map.on('click', (e) => {
                const features = state.map.queryRenderedFeatures(e.point, { layers: ['planes-layer'] });
                if (features.length > 0) return;

                state.useGeo = false;
                state.lat = e.lngLat.lat;
                state.lon = e.lngLat.lng;

                state.map.flyTo({ center: [state.lon, state.lat], speed: 0.8 });
                updateUserLocation(state.lat, state.lon);

                const latDir = state.lat >= 0 ? 'N' : 'S';
                const lonDir = state.lon >= 0 ? 'E' : 'W';
                DOM.locationDisplay.textContent = `${Math.abs(state.lat).toFixed(2)}° ${latDir}`;
                DOM.statusDisplay.textContent = `${Math.abs(state.lon).toFixed(2)}° ${lonDir}`;
                DOM.resetBtn.style.display = 'flex';

                haptic('medium');
                fetchPlanes();
                updateWeather(true);
            });
        });

        // Cockpit map
        state.cockpitMap = new maplibregl.Map({
            container: 'cockpitMap',
            style: {
                version: 8,
                sources: {
                    'satellite': { type: 'raster', tiles: [CONFIG.SAT_TILES], tileSize: 256 },
                    'terrain-source': { type: 'raster-dem', url: 'https://demotiles.maplibre.org/terrain-tiles/tiles.json', tileSize: 256 }
                },
                layers: [{ id: 'sat', type: 'raster', source: 'satellite', paint: { 'raster-saturation': -0.4 }}],
                sky: { 'sky-color': '#050510', 'sky-horizon-blend': 0.3, 'horizon-color': '#0a2a4a', 'fog-color': '#0a2a4a' },
                terrain: { source: 'terrain-source', exaggeration: 1.1 }
            },
            center: [0, 0], zoom: 12, pitch: 85, maxPitch: 85, interactive: false
        });

    } catch (e) {
        console.error('Map init error:', e);
    }
}

function updateUserLocation(lat, lon) {
    if (!state.map || !state.map.getSource('user-location')) return;
    state.map.getSource('user-location').setData({
        type: 'FeatureCollection',
        features: [{ type: 'Feature', geometry: { type: 'Point', coordinates: [lon, lat] }}]
    });
}

// === DATA FETCHING ===
async function fetchPlanes() {
    if (!state.lat || state.isFetchingPlanes) return;
    state.isFetchingPlanes = true;

    try {
        const url = `${CONFIG.API_PLANES}${state.lat}/${state.lon}/${state.radius}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const now = Date.now();
        const activeHexes = new Set();

        if (data.ac) {
            data.ac.forEach(p => {
                if (!p.lat || !p.lon) return;
                activeHexes.add(p.hex);

                const speedKmh = (p.gs || 0) * CONFIG.KNOTS_TO_KMH;
                const distanceIn5s = speedKmh * (5.5 / 3600);
                const projected = getProjectedPoint(p.lat, p.lon, p.track || 0, distanceIn5s);

                let pData = state.planesData.get(p.hex);
                if (pData) {
                    // Add current position to trail history
                    if (!pData.trail) pData.trail = [];
                    pData.trail.push([pData.currentLon, pData.currentLat]);
                    // Keep trail to reasonable length (last 30 positions = ~2.5 minutes at 5s intervals)
                    if (pData.trail.length > 30) pData.trail.shift();
                    
                    pData.startLat = pData.currentLat; pData.startLon = pData.currentLon;
                    pData.targetLat = projected[1]; pData.targetLon = projected[0];
                    pData.startTime = now;
                    Object.assign(pData, { alt_baro: p.alt_baro, gs: p.gs, track: p.track, flight: p.flight, t: p.t, baro_rate: p.baro_rate, category: p.category });
                } else {
                    pData = {
                        ...p, currentLat: p.lat, currentLon: p.lon,
                        startLat: p.lat, startLon: p.lon,
                        targetLat: projected[1], targetLon: projected[0],
                        startTime: now,
                        trail: [[p.lon, p.lat]]
                    };
                    state.planesData.set(p.hex, pData);
                }
            });

            const count = activeHexes.size;
            DOM.planeCount.textContent = count;
            
            // Show/hide empty state
            if (count === 0) {
                DOM.emptyState.classList.add('show');
                document.querySelector('.aircraft-count').style.display = 'none';
            } else {
                DOM.emptyState.classList.remove('show');
                document.querySelector('.aircraft-count').style.display = 'block';
            }

            // Show first-time tip
            if (count > 0 && !state.hasSeenPlaneTip) {
                state.hasSeenPlaneTip = true;
                localStorage.setItem('pp-seen-plane-tip', 'true');
                showToast('Tap a plane icon to enter cockpit view', 4000);
            }

            for (let [hex] of state.planesData) {
                if (!activeHexes.has(hex)) {
                    state.planesData.delete(hex);
                    if (state.selectedHex === hex && state.mode === 'cockpit') {
                        showToast('Aircraft left tracking area');
                        exitCockpitMode();
                    }
                }
            }
        }
    } catch (e) {
        console.error('Plane fetch error:', e);
    } finally {
        state.isFetchingPlanes = false;
    }
}

function updateWeather(force = false) {
    if (!state.lat || !state.lon) return;
    const now = Date.now();
    if (!force && now - state.lastWxUpdate < CONFIG.WX_POLL_MS) return;
    state.lastWxUpdate = now;

    // Clear cached station when forcing update (location changed)
    if (force) state.cachedStationUrl = null;

    const headers = { 'User-Agent': '(planepatrol.app, contact@example.com)' };

    const fetchObs = (url) => fetch(url + '/observations/latest', { headers })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(d => {
            // Verify we actually got valid temperature data
            if (d.properties.temperature.value === null) return Promise.reject('No temp data');
            return d;
        });

    const tryStations = (stations, index = 0) => {
        if (index >= stations.length || index >= 5) return Promise.reject('No stations with data');
        const stationUrl = stations[index].id;
        return fetchObs(stationUrl)
            .then(data => {
                state.cachedStationUrl = stationUrl; // Cache the working station
                return data;
            })
            .catch(() => tryStations(stations, index + 1)); // Try next station
    };

    const weatherPromise = state.cachedStationUrl
        ? fetchObs(state.cachedStationUrl).catch(() => { state.cachedStationUrl = null; return null; })
        : Promise.resolve(null);

    weatherPromise.then(cachedData => {
        if (cachedData) return cachedData;
        return fetch(`${CONFIG.API_WX_POINTS}${state.lat},${state.lon}`, { headers })
            .then(r => r.json())
            .then(d => fetch(d.properties.observationStations, { headers }))
            .then(r => r.json())
            .then(d => tryStations(d.features));
    })
    .then(d => {
        const p = d.properties;
        const tempC = p.temperature.value;
        const tempF = tempC !== null ? Math.round((tempC * 9/5) + 32) : '--';
        DOM.wxTemp.textContent = `${tempF}°`;
        DOM.wxCond.textContent = (p.textDescription || 'Clear').split(' ').slice(0, 2).join(' ');
        const windMS = p.windSpeed.value;
        DOM.wxWind.textContent = windMS !== null ? Math.round(windMS * 1.94384) : '--';
    })
    .catch(() => {
        DOM.wxTemp.textContent = '--°';
        DOM.wxCond.textContent = 'Offline';
        DOM.wxWind.textContent = '--';
    });
}

// === ANIMATION ===
function animatePlanes() {
    if (document.hidden) { requestAnimationFrame(animatePlanes); return; }

    const now = Date.now();
    if (now - state.lastAnimateTime < 33) { requestAnimationFrame(animatePlanes); return; }
    state.lastAnimateTime = now;

    if (state.mode === 'cockpit') updateCockpitView();

    if (!state.map || !state.map.getSource('planes')) { requestAnimationFrame(animatePlanes); return; }

    const planeFeatures = [];
    const trailFeatures = [];
    const predictionFeatures = [];

    state.planesData.forEach((p, hex) => {
        const progress = Math.min((now - p.startTime) / CONFIG.ANIMATION_DURATION, 1);
        p.currentLat = p.startLat + (p.targetLat - p.startLat) * progress;
        p.currentLon = p.startLon + (p.targetLon - p.startLon) * progress;

        const callsign = p.flight ? p.flight.trim() : p.hex;
        const alt = p.alt_baro === 'ground' ? 'GND' : Math.round(p.alt_baro / 100) * 100;
        const desc = `${alt}ft · ${Math.round(p.gs || 0)}kt`;

        planeFeatures.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [p.currentLon, p.currentLat] },
            properties: { hex, rotation: p.track || 0, callsign, desc, icon: getIconType(p.t, p.category) }
        });

        // Add trail behind aircraft
        if (p.trail && p.trail.length > 1 && p.alt_baro !== 'ground') {
            const trailCoords = [...p.trail, [p.currentLon, p.currentLat]];
            trailFeatures.push({
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: trailCoords }
            });
        }

        // Add prediction line ahead (60 seconds ahead based on current speed/heading)
        if (p.gs > 50 && p.alt_baro !== 'ground' && p.track !== undefined) {
            const speedKmh = p.gs * CONFIG.KNOTS_TO_KMH;
            const predictionDist = speedKmh * (60 / 3600); // 60 seconds ahead
            const futurePoint = getProjectedPoint(p.currentLat, p.currentLon, p.track, predictionDist);
            predictionFeatures.push({
                type: 'Feature',
                geometry: { 
                    type: 'LineString', 
                    coordinates: [[p.currentLon, p.currentLat], futurePoint]
                }
            });
        }
    });

    state.map.getSource('planes').setData({ type: 'FeatureCollection', features: planeFeatures });
    state.map.getSource('flight-trails').setData({ type: 'FeatureCollection', features: trailFeatures });
    state.map.getSource('flight-predictions').setData({ type: 'FeatureCollection', features: predictionFeatures });

    requestAnimationFrame(animatePlanes);
}

// === COCKPIT MODE ===
function enterCockpitMode(hex) {
    const p = state.planesData.get(hex);
    if (!p) return;

    haptic('medium');
    
    state.selectedHex = hex;
    state.mode = 'cockpit';

    // Sync sound toggle button visual state
    const soundBtn = document.getElementById('cockpitSoundToggle');
    soundBtn.classList.toggle('active', state.soundEnabled);

    // Start engine sounds
    const iconType = getIconType(p.t, p.category);
    let soundType = 'jet';
    if (iconType === 'heli-icon') soundType = 'heli';
    else if (iconType === 'plane-prop') soundType = 'prop';
    engineAudio.play(soundType);

    DOM.mainView.classList.add('hidden');
    DOM.cockpitView.classList.add('active');
    state.cockpitMap.resize();

    // Show first-time cockpit tip
    if (!state.hasSeenCockpitTip) {
        state.hasSeenCockpitTip = true;
        localStorage.setItem('pp-seen-cockpit-tip', 'true');
        setTimeout(() => {
            showToast('Locked to aircraft. Toggle sound for engine noise.', 4000);
        }, 800);
    }

    setTimeout(() => {
        if (state.mode === 'cockpit') document.getElementById('map').style.visibility = 'hidden';
    }, 500);
}

function exitCockpitMode() {
    engineAudio.stop(); // Stop engine sounds

    document.getElementById('map').style.visibility = 'visible';
    state.mode = 'radar';
    state.selectedHex = null;
    DOM.cockpitView.classList.remove('active');
    DOM.mainView.classList.remove('hidden');
    state.map.resize();
    if (state.lat && state.lon) {
        state.map.flyTo({ center: [state.lon, state.lat], zoom: getZoomForRadius(state.radius), pitch: 0 });
    }
    showToast('Back to radar view');
}

function updateCockpitView() {
    if (!state.selectedHex || !state.cockpitMap) return;
    const p = state.planesData.get(state.selectedHex);
    if (!p) return;

    DOM.cCallsign.textContent = p.flight ? p.flight.trim() : (p.r || p.hex);
    DOM.cType.textContent = getAircraftTypeName(p.t);
    DOM.cDist.textContent = calcDist(state.lat, state.lon, p.currentLat, p.currentLon).toFixed(1);
    DOM.cAlt.textContent = p.alt_baro === 'ground' ? 'GND' : Math.round(p.alt_baro).toLocaleString();
    DOM.cSpd.textContent = Math.round(p.gs || 0);
    DOM.cStatus.textContent = getFlightPhase(p);

    const heading = p.track || 0;
    document.getElementById('compassRing').style.transform = `rotate(-${heading}deg)`;

    const alt = p.alt_baro === 'ground' ? 0 : p.alt_baro;
    const zoom = Math.max(9, 16 - (alt / 6000));
    const leadDist = Math.max(0.5, (17 - zoom) * 2.5);
    const target = getProjectedPoint(p.currentLat, p.currentLon, p.track || 0, leadDist);

    state.cockpitMap.jumpTo({ center: target, zoom, pitch: 80, bearing: p.track || 0 });
}

// === SETTINGS & CONTROLS ===
function toggleSettings() {
    DOM.settingsPanel.classList.toggle('open');
    DOM.settingsOverlay.classList.toggle('open');
}

function selectLocationSource(source) {
    document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
    document.getElementById('opt' + (source === 'geo' ? 'Geo' : source))?.classList.add('selected');
    DOM.resetBtn.style.display = 'none';

    if (source === 'geo') {
        state.useGeo = true;
        if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }

        if (state.lastKnownGeo) {
            state.lat = state.lastKnownGeo.lat;
            state.lon = state.lastKnownGeo.lon;
            DOM.locationDisplay.textContent = `${state.lat.toFixed(2)}° N`;
            DOM.statusDisplay.textContent = 'Live';
            if (state.map) {
                state.map.flyTo({ center: [state.lon, state.lat], zoom: getZoomForRadius(state.radius) });
                updateUserLocation(state.lat, state.lon);
            }
            updateWeather(true);
            fetchPlanes();
        }

        if (navigator.geolocation) {
            state.watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    state.lastKnownGeo = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    if (state.useGeo) {
                        state.lat = pos.coords.latitude;
                        state.lon = pos.coords.longitude;
                        DOM.locationDisplay.textContent = `${state.lat.toFixed(2)}° N`;
                        DOM.statusDisplay.textContent = 'Live';
                        if (state.map) {
                            state.map.setCenter([state.lon, state.lat]);
                            updateUserLocation(state.lat, state.lon);
                        }
                        updateWeather();
                        fetchPlanes();
                    }
                },
                () => DOM.statusDisplay.textContent = 'Retrying',
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }
    } else {
        state.useGeo = false;
        if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }

        const airport = CONFIG.LOCATIONS[source];
        state.lat = airport.lat;
        state.lon = airport.lon;
        DOM.locationDisplay.textContent = airport.name;
        DOM.statusDisplay.textContent = 'Active';
        updateWeather(true);
        if (state.map) {
            state.map.flyTo({ center: [state.lon, state.lat], zoom: getZoomForRadius(state.radius) });
            updateUserLocation(state.lat, state.lon);
        }
        fetchPlanes();
    }
}

function selectRadius(r) {
    state.radius = r;
    document.querySelectorAll('.range-chip').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.range) === r);
    });
    DOM.rangeLabel.textContent = `within ${r} mi`;
    fetchPlanes();
    if (state.map) state.map.setZoom(getZoomForRadius(r));
}

function resetToGPS() {
    selectLocationSource('geo');
    DOM.resetBtn.style.display = 'none';
}

// === APP LIFECYCLE ===
function startApp() {
    if (!state.map) {
        state.lat = 39.8; state.lon = -98.5;
        initMap();
        if (state.map) { state.map.dragPan.disable(); state.map.scrollZoom.disable(); }
    }
// Silent Audio Unlocker: Wakes up the audio engine on the very first user interaction
    const unlockAudio = () => {
        if (engineAudio.ctx && engineAudio.ctx.state === 'suspended') {
            engineAudio.ctx.resume();
        } else if (!engineAudio.ctx) {
            engineAudio.init(); // Initialize if not created yet
        }
        // Remove listener after first successful interaction
        ['click', 'touchstart'].forEach(evt => 
            document.removeEventListener(evt, unlockAudio)
        );
    };

    ['click', 'touchstart'].forEach(evt => 
        document.addEventListener(evt, unlockAudio, { once: true, passive: true })
    );
    if (navigator.geolocation) {
        if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }

        state.watchId = navigator.geolocation.watchPosition(
            (pos) => {
                state.lastKnownGeo = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                if (state.useGeo) {
                    const isFirstLock = !state.hasLockedLocation;
                    state.hasLockedLocation = true;
                    state.lat = pos.coords.latitude;
                    state.lon = pos.coords.longitude;

                    DOM.locationDisplay.textContent = `${state.lat.toFixed(2)}° N`;
                    DOM.statusDisplay.textContent = 'Live';

                    if (isFirstLock) {
                        setTimeout(() => {
                            DOM.splashScreen.classList.add('hidden');
                        }, 800);
                    }

                    if (state.map && state.mode === 'radar') {
                        state.map.dragPan.enable();
                        state.map.scrollZoom.enable();
                        if (isFirstLock) {
                            state.map.flyTo({ center: [state.lon, state.lat], zoom: getZoomForRadius(state.radius) });
                        } else {
                            state.map.setCenter([state.lon, state.lat]);
                        }
                        updateUserLocation(state.lat, state.lon);
                    }
                    updateWeather();
                    fetchPlanes();
                }
            },
            () => DOM.statusDisplay.textContent = 'Retrying',
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    }

    state.planeInterval = setInterval(fetchPlanes, CONFIG.POLL_MS);
    state.wxInterval = setInterval(() => updateWeather(), CONFIG.WX_POLL_MS);
    requestAnimationFrame(animatePlanes);
}

function quitApp() {
    if (state.planeInterval) { clearInterval(state.planeInterval); state.planeInterval = null; }
    if (state.wxInterval) { clearInterval(state.wxInterval); state.wxInterval = null; }
    if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }
    engineAudio.stop();

    document.getElementById('offlineOverlay').style.display = 'flex';
    DOM.statusDisplay.textContent = 'Offline';
    DOM.planeCount.textContent = '0';
}

function wakeApp() {
    document.getElementById('offlineOverlay').style.display = 'none';
    startApp();
}

// === EVENT LISTENERS ===
document.getElementById('settingsBtn').addEventListener('click', () => { haptic('light'); toggleSettings(); });
document.getElementById('settingsDone').addEventListener('click', () => { haptic('light'); toggleSettings(); });
document.getElementById('settingsOverlay').addEventListener('click', () => { haptic('light'); toggleSettings(); });

document.getElementById('optGeo').addEventListener('click', () => { haptic('light'); selectLocationSource('geo'); });
document.getElementById('optJFK').addEventListener('click', () => { haptic('light'); selectLocationSource('JFK'); });
document.getElementById('optLAX').addEventListener('click', () => { haptic('light'); selectLocationSource('LAX'); });
document.getElementById('optATL').addEventListener('click', () => { haptic('light'); selectLocationSource('ATL'); });

document.querySelectorAll('.range-chip').forEach(el => {
    el.addEventListener('click', () => { haptic('light'); selectRadius(parseInt(el.dataset.range)); });
});

document.getElementById('radarToggle').addEventListener('click', () => {
    haptic('light');
    state.radarEnabled = !state.radarEnabled;
    document.getElementById('radarToggle').classList.toggle('active');
    if (state.map && state.map.getLayer('radar-layer')) {
        state.map.setLayoutProperty('radar-layer', 'visibility', state.radarEnabled ? 'visible' : 'none');
    }
});

// Theme toggle
document.getElementById('themeToggle').addEventListener('click', () => {
    haptic('light');
    setTheme(!state.lightTheme);
});

// Sound toggle in cockpit
document.getElementById('cockpitSoundToggle').addEventListener('click', () => {
    haptic('light');
    state.soundEnabled = !state.soundEnabled;
    document.getElementById('cockpitSoundToggle').classList.toggle('active', state.soundEnabled);
    
    // Immediately start or stop sound based on new state
    if (state.mode === 'cockpit' && state.selectedHex) {
        if (state.soundEnabled) {
            const p = state.planesData.get(state.selectedHex);
            if (p) {
                const iconType = getIconType(p.t, p.category);
                let soundType = 'jet';
                if (iconType === 'heli-icon') soundType = 'heli';
                else if (iconType === 'plane-prop') soundType = 'prop';
                engineAudio.play(soundType);
            }
        } else {
            engineAudio.stop();
        }
    }
});

document.getElementById('resetBtn').addEventListener('click', () => { haptic('light'); resetToGPS(); });
document.getElementById('backBtn').addEventListener('click', () => { haptic('light'); exitCockpitMode(); });
document.getElementById('quitBtn').addEventListener('click', () => {
    haptic('medium');
    if (confirm('Pause tracking to save battery?')) quitApp();
});
document.getElementById('wakeBtn').addEventListener('click', () => { haptic('medium'); wakeApp(); });

// Settings swipe-to-close
let settingsStartX = 0;
let settingsCurrentX = 0;
let isSwipingSettings = false;

DOM.settingsPanel.addEventListener('touchstart', (e) => {
    settingsStartX = e.touches[0].clientX;
    isSwipingSettings = true;
}, { passive: true });

DOM.settingsPanel.addEventListener('touchmove', (e) => {
    if (!isSwipingSettings) return;
    settingsCurrentX = e.touches[0].clientX;
    const diff = settingsCurrentX - settingsStartX;
    if (diff > 0) {
        DOM.settingsPanel.style.transform = `translateX(${diff}px)`;
    }
}, { passive: true });

DOM.settingsPanel.addEventListener('touchend', () => {
    if (!isSwipingSettings) return;
    isSwipingSettings = false;
    const diff = settingsCurrentX - settingsStartX;
    DOM.settingsPanel.style.transform = '';
    if (diff > 100) {
        haptic('light');
        toggleSettings();
    }
    settingsStartX = 0;
    settingsCurrentX = 0;
});

// Load saved theme
const savedTheme = localStorage.getItem('planepatrol-theme');
if (savedTheme === 'light') setTheme(true);

// Idle timer
let lastActivity = Date.now();
setInterval(() => {
    if ((Date.now() - lastActivity) / 60000 > 30) {
        quitApp();
        lastActivity = Date.now();
    }
}, 60000);

['click', 'touchstart', 'mousemove'].forEach(evt =>
    document.addEventListener(evt, () => lastActivity = Date.now(), { passive: true })
);

// Cleanup
window.addEventListener('beforeunload', () => {
    if (state.wxInterval) clearInterval(state.wxInterval);
    if (state.planeInterval) clearInterval(state.planeInterval);
    if (state.watchId) navigator.geolocation.clearWatch(state.watchId);
    if (state.map) state.map.remove();
    if (state.cockpitMap) state.cockpitMap.remove();
    engineAudio.stop();
});

// Start
window.onload = startApp;
</script>
</body>
</html>